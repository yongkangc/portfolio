<!DOCTYPE html>
<html lang=""><head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  <title>Arbitrage Trading Guide</title>
  <meta name="description" content="Blockchain Engineer" />
  <meta name="author" content="Chia Yong Kang" />

  <link
    href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Inconsolata:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"
    integrity="sha512-rt/SrQ4UNIaGfDyEXZtNcyWvQeOq0QLygHluFQcSjaGB04IxWhal71tKuzP6K8eYXYB6vJV4pHkXcmFGGQ1/0w=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.3/css/academicons.min.css"
    integrity="sha512-vaoopdl+FJahyY2ddhsbDj8yDiRuyUYH/vIjF3z+cBg0sKc07NAQmUYli8volCGlW9OwlQyjVsr7Lh6qAManlw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="/css/syntax.css" /> <link
  rel="stylesheet" href="/css/custom.css" /> <link rel="stylesheet" href="/sass/researcher.min.css" />

  <link rel="icon" type="image/ico" href="https://chiayong.com/crab.svg" />
  <script>var doNotTrack = false;if (!doNotTrack) {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D5HBRC62LK');
  }
</script> 
</head>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
  integrity="sha384-n8MVd4RsNIU0KOVEMeaMurDc6z2IzYKLHVEYjHI8rwlK3+zv+s/g9yr52+bmGNEF"
  crossorigin="anonymous"
/>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
  integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
  crossorigin="anonymous"
></script>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
  integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
  crossorigin="anonymous"
></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      
      
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true },
      ],
      
      throwOnError: false,
    });
  });
</script>

  <body><div class="container-fluid site-header">
  <nav class="navbar navbar-expand-lg navbar-light">
    <a class="navbar-brand" href="https://chiayong.com/">Chia Yong Kang</a>
    <button
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#navbarNav"
      aria-controls="navbarNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          <a class="nav-link" href="https://chiayong.com/">About</a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="https://chiayong.com/articles">Articles</a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="https://chiayong.com/contact">Contact</a>
        </li>
        
      </ul>
    </div>
  </nav>
</div>
<div class="main-content">
      <div id="content">
<div class="container">
  <div class="single">
    <div class="single-header">
      <h1 class="single-title">Arbitrage Trading Guide</h1>
      <div class="single-meta">
        <span class="single-date"> June 21, 2025 </span>
      </div>
    </div>
    <div class="article-content"><h1 id="introduction">Introduction</h1>
<p>Let&rsquo;s start with the textbook basics - the definition. What is arbitrage afterall? Well, the dictionary will give you this definition:</p>
<blockquote>
<p>the simultaneous buying and selling of securities, currency, or commodities in different markets or in derivative forms in order to take advantage of differing prices for the same asset.</p></blockquote>
<p>I&rsquo;d say this is a fairly good definition for arbitrage in the traditional sense, but in the modern sense&hellip; I&rsquo;m not really sure this is true. Most advanced arbitrage trading doesn&rsquo;t hedge the other side of the trade simultaneously at all. If you are in and out of the position in a couple seconds, then why would you even care about being hedged? Especially if you know that the side you are trading is the one doing all the moving.</p>
<ul>
<li><strong>Venue-specific market microstructure</strong>: Understanding how each exchange&rsquo;s matching engine works, including order types, priority rules, and latency characteristics</li>
<li><strong>Liquidity concentration analysis</strong>: Using Level 2 data to identify where real liquidity sits versus displayed liquidity</li>
<li><strong>Cross-venue correlation matrices</strong>: Quantifying how price movements propagate between exchanges using techniques like Vector Autoregression (VAR) models</li>
<li><strong>Flow toxicity detection</strong>: Identifying when large players are moving markets versus normal retail flow</li>
</ul>
<p>The mathematical foundation for this approach involves modeling the price impact function for each venue:</p>
<p>$$ \Delta P_i = \alpha_i \cdot \left(\frac{\text{Volume}}{\text{AverageVolume}}\right)^{\beta_i} \cdot \sigma_i $$</p>
<p>Where ΔP_i is the expected price impact on venue i, α_i and β_i are venue-specific parameters, and σ_i is the recent volatility. Professional systems calibrate these parameters in real-time using recursive least squares or Kalman filtering.</p>
<p>Let&rsquo;s say we have two exchanges, ShitEx and MegaEx. MegaEx trades 500 billion USD a day. ShitEx trades about 500 million USD a day. If they diverge do you really expect that MegaEx and ShitEx will both meet in the middle? Probably not&hellip; In fact, ShitEx will do almost all of the moving, which we can round to 100% of the moving when we consider that we really only care about moves that occur in excess of our cost to trade (which is very non-trivial for this kind of trading).</p>
<p>This is just the introduction so we&rsquo;ll avoid diving into too much of the advanced weeds but you can already see from this example that the textbook definition isn&rsquo;t quite what arbitrage trading looks like in practice. In today&rsquo;s article, I will take a walk through all the different forms of arbitrage trading and what it realistically looks like to trade these opportunities. Not simply taking the textbook approach, but showing how real money gets made by professional arbitrageurs.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#types-of-arbitrage">Types of Arbitrage</a></li>
<li><a href="#where-can-i-find-alpha">Where Can &ldquo;I&rdquo; Find Alpha?</a>
<ul>
<li><a href="#professional-alpha-sourcing-framework">Professional Alpha Sourcing Framework</a></li>
<li><a href="#professional-due-diligence-for-new-exchanges">Professional Due Diligence for New Exchanges</a></li>
</ul>
</li>
<li><a href="#execution">Execution</a></li>
<li><a href="#when-should-you-hedge">When Should You Hedge?</a></li>
<li><a href="#when-you-have-to-predict">When You Have To Predict</a></li>
<li><a href="#incompletes">Incompletes</a></li>
<li><a href="#normalization">Normalization</a></li>
<li><a href="#reducing-trading-costs">Reducing Trading Costs</a>
<ul>
<li><a href="#trading-more-things">Trading More Things</a></li>
<li><a href="#leverage--borrowing">Leverage &amp; Borrowing</a></li>
</ul>
</li>
<li><a href="#strategy-deep-dives">Strategy Deep Dives</a>
<ul>
<li><a href="#funding-arbitrage">Funding Arbitrage</a></li>
<li><a href="#spot-arbitrage">Spot Arbitrage</a></li>
<li><a href="#perpetuals-arbitrage">Perpetuals Arbitrage</a></li>
<li><a href="#triangular-arbitrage">Triangular Arbitrage</a>
<ul>
<li><a href="#professional-implementation-guide-triangular-arbitrage-systems">Professional Implementation Guide: Triangular Arbitrage Systems</a></li>
</ul>
</li>
<li><a href="#geographic-arbitrage">Geographic Arbitrage</a></li>
</ul>
</li>
</ol>
<hr>
<h1 id="types-of-arbitrage">Types of Arbitrage</h1>
<p>There are many types of arbitrage outside of digital asset markets, but those tend to be quite complicated and require institutional levels of resources. The primary advantage of arbitrage in digital asset markets is the feasibility for even small teams / solo quants, something that is much rarer in traditional markets.</p>
<p>At a high level:</p>
<ol>
<li>Funding Arbitrage</li>
<li>Spot Arbitrage</li>
<li>Dated Futures Arbitrage</li>
<li>Perpetuals Arbitrage</li>
<li>Triangular Arbitrage</li>
<li>Geographic Arbitrage</li>
</ol>
<p><strong>For professional implementation, each strategy requires distinct infrastructure and risk management approaches:</strong></p>
<p><strong>Professional Strategy Classification Matrix:</strong></p>
<ul>
<li><strong>Latency-Sensitive</strong>: Triangular, Perpetuals, Spot (requires &lt;10ms execution)</li>
<li><strong>Capital-Intensive</strong>: Funding, Geographic (requires significant inventory management)</li>
<li><strong>Research-Heavy</strong>: Dated Futures, Geographic (requires fundamental analysis)</li>
</ul>
<p><strong>Risk-Return Profiles (Professional Benchmarks):</strong></p>
<ul>
<li>Funding Arbitrage: 15-40% APR, Sharpe 3-8, Max DD &lt;2%</li>
<li>Spot Arbitrage: 50-200% APR, Sharpe 2-5, Max DD 5-15%</li>
<li>Perpetuals Arbitrage: 100-500% APR, Sharpe 1.5-4, Max DD 10-25%</li>
<li>Triangular Arbitrage: 200-1000% APR, Sharpe 1-3, Max DD 15-35%</li>
</ul>
<p><strong>Infrastructure Requirements by Strategy:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">STRATEGY_REQUIREMENTS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="s1">&#39;funding&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="s1">&#39;perpetuals&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="s1">&#39;very_high&#39;</span><span class="p">,</span> <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="s1">&#39;triangular&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="s1">&#39;very_high&#39;</span><span class="p">,</span> <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Funding Arbitrage involves profiting from the funding payments paid out by perpetual contracts in order to keep them aligned with their index price. Typically it is done with a spot (long/short) position against the opposite position in the perpetual, this then accrues funding payments whilst they remain apart. It can also be done using a perpetual against another perpetual, this is less common and typically has more room for return, but also is harder to pull off. Especially when doing spot vs perp, funding arb is perhaps the simplest of all the arbitrage strategies to pull off and deliver a return with, but it is also one of the most capped in terms of profit potential. The returns will be broadly similar for all people running the strategy, especially when running it with serious size. Funding arbitrage is generally treated as the cash benchmark for most multi-strategy funds because it offers a reasonable return at a very high Sharpe. It&rsquo;s also fairly easy to rotate spare cash into, and doesn&rsquo;t require a lot of research to develop a sufficient strategy for.</p>
<p>Spot Arbitrage on the other hand is more competitive. It involves buying on one exchange and selling on another, earning the difference of those prices. You&rsquo;ll typically need to withdraw from one exchange and transfer to the other exchange in order to reconcile, meaning you may not be able to buy &amp; sell at the same time on each. In some cases you may be able to get borrowing margin, but this is generally quite rare.</p>
<div class="mermaid">sequenceDiagram
    participant Trader
    participant A as "Ex A ($60k)"
    participant B as "Ex B ($60.1k)"

    Trader->>A: Buy 1 BTC (Long Position)
    activate A
    A-->>Trader: 1 BTC Bought
    deactivate A

    Trader->>B: Sell 1 BTC (Short Position)
    activate B
    B-->>Trader: 1 BTC Sold (Short)
    deactivate B

    Note over Trader: Position +1 BTC on Exchange A, -1 BTC on Exchange B<br>Profit $100 (unrealized, pending short cover)

    loop Reconciliation (Covering Short Position)
        Trader->>A: Withdraw 1 BTC
        activate A
        A-->>Trader: 1 BTC Sent
        deactivate A

        Trader->>B: Deposit 1 BTC (to cover short)
        activate B
        B-->>Trader: 1 BTC Received (Short Covered)
        deactivate B
    end</div>
<p>Dated Futures Arbitrage involves taking a position in spot (long/short) and then taking the opposite position in a dated future, and waiting until expiry (or convergence) to exit. It&rsquo;s fairly rare as the returns compared to funding arbitrage are typically worse and they tend to give higher volatility, however, in some circumstances the return can be quite exceptional. There are also concerns about the lack of liquidity with dated futures so it is only really relevant for smaller book sizes.</p>
<p>Perpetuals Arbitrage is between two perpetuals and bets on their convergence. It is technically a form of statistical arbitrage because you can&rsquo;t actually reconcile the positions, and they are completely different assets with different contract specifications and index prices. That said, they&rsquo;ll still converge as if they&rsquo;re the exact same asset in most cases. There are still mechanisms which keep them in place even if they are a bit more complicated than spot:</p>
<div class="mermaid">graph TD
BPerp[Binance Perp] -->|Funding Rate| BSpot[Binance Spot]
OPerp[Okx Perp] -->|Funding Rate| OSpot[Okx Spot]
BSpot -- Spot arbitrage --> OSpot</div>
<p>So they can&rsquo;t stay apart forever, but you also may have to face the margin man if you get blown out of your position. Typically this isn&rsquo;t too much of a worry as these trades tend to be fairly rapid and the size you can actually put on is a very small fraction of your portfolio.</p>
<p>Triangular Arbitrage or more technically circular arbitrage, is any conversion of spot assets that ends up back where you started and with more money. I call it circular arbitrage because you do not necessarily need 3 legs, you can have N legs s.t. N &gt;= 3. I used to run this on Binance and it was very profitable for a while until the bear market hit and liquidity / volumes dried up in small caps.</p>
<div class="mermaid">graph LR
A(1 BTC)
B(14 ETH)
C(45,000 USDC)

    A -- BTC/ETH --> B
    B -- ETH/USDC --> C
    C -- USDC/BTC --> A</div>
<p>Geographic arbitrage is basically spot arbitrage but for foreign exchange markets where you arbitrage local vs international markets for that currency. The reason it is technically a crypto strategy is because you usually buy up the currency on their local crypto exchanges because there is usually a really large imbalance of pricing there due to people using crypto to pull money out of the economy (when it may be quite a pain to do normally). This one is mostly an operational challenge and isn&rsquo;t an edge I&rsquo;d recommend unless you love paperwork and arguing with foreign bureaucrats.</p>
<p>We&rsquo;ll dig into each of these strategies at a deep level of detail towards the end of the article.</p>
<h1 id="where-can-i-find-alpha">Where can &ldquo;I&rdquo; find alpha?</h1>
<p>Sure, this is interesting to learn about, but I expect the real question you are asking yourself is where can I find alpha? The answer is usually on small exchanges, or during regimes where returns are exceptionally high.</p>
<h2 id="professional-alpha-sourcing-framework">Professional Alpha Sourcing Framework</h2>
<p><strong>Tier 1 Opportunities (Systematic Alpha):</strong></p>
<ul>
<li><strong>Emerging Exchanges</strong>: Target exchanges with &lt;$1B daily volume but growing &gt;50% monthly</li>
<li><strong>New Listing Arbitrage</strong>: Monitor new token listings across exchanges (typical 2-6 hour inefficiency window)</li>
<li><strong>Derivative Launch Arbitrage</strong>: New perpetual/futures listings often have 24-48 hour pricing inefficiencies</li>
</ul>
<p><strong>Tier 2 Opportunities (Regime-Dependent Alpha):</strong></p>
<ul>
<li><strong>Funding Rate Explosions</strong>: Systematic monitoring for funding rates &gt;100% APR (occurs ~6-8 times/year)</li>
<li><strong>Liquidation Cascades</strong>: Monitor margin call data for predictive signals</li>
<li><strong>Cross-Chain Bridge Arbitrage</strong>: Exploit temporary cross-chain pricing inefficiencies</li>
</ul>
<p><strong>Professional Monitoring Infrastructure:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Example alpha monitoring system</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">AlphaMonitor</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_exchange_config</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">            <span class="s1">&#39;funding_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># 1% funding rate threshold</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            <span class="s1">&#39;spot_spread&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>  <span class="c1"># 0.5% spread threshold</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">            <span class="s1">&#39;volume_spike&#39;</span><span class="p">:</span> <span class="mf">3.0</span>    <span class="c1"># 3x normal volume</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">monitor_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="k">for</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">            <span class="n">funding_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_funding_rates</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">            <span class="n">spot_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spot_prices</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="n">opportunities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_opportunities</span><span class="p">(</span><span class="n">funding_data</span><span class="p">,</span> <span class="n">spot_data</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_opportunities</span><span class="p">(</span><span class="n">opportunities</span><span class="p">)</span>
</span></span></code></pre></div><p>Especially on new and growing exchanges, you&rsquo;ll find the best alpha. This will be because of various reasons:</p>
<ul>
<li>Willing to offer you attractive fees</li>
<li>Reward programs</li>
<li>Lots of retail flow without established players on exchange yet</li>
<li>Weak quoting from the exchange MMs who are under contract</li>
</ul>
<h2 id="professional-due-diligence-for-new-exchanges">Professional Due Diligence for New Exchanges</h2>
<p><strong>Technical Infrastructure Assessment:</strong></p>
<ul>
<li>API latency testing (measure p50, p95, p99 response times)</li>
<li>WebSocket stability testing (monitor disconnection rates)</li>
<li>Order execution quality analysis (slippage, rejection rates)</li>
<li>Withdrawal reliability testing (time to process, failure rates)</li>
</ul>
<p><strong>Liquidity Analysis:</strong></p>
<ul>
<li>Effective spread analysis across different times of day</li>
<li>Market depth analysis (liquidity beyond best bid/ask)</li>
<li>Price impact modeling for various order sizes</li>
<li>Market maker behavior analysis (quote update frequency, depth changes)</li>
</ul>
<p><strong>Risk Assessment Matrix:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">EXCHANGE_RISK_FACTORS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;api_reliability&#39;</span><span class="p">,</span> <span class="s1">&#39;latency_stability&#39;</span><span class="p">,</span> <span class="s1">&#39;order_execution&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="s1">&#39;operational&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;withdrawal_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_support&#39;</span><span class="p">,</span> <span class="s1">&#39;regulatory_status&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="s1">&#39;financial&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;insurance_fund&#39;</span><span class="p">,</span> <span class="s1">&#39;segregated_funds&#39;</span><span class="p">,</span> <span class="s1">&#39;audit_status&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;liquidity_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;maker_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_handling&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Integration Priority Framework:</strong></p>
<ol>
<li><strong>Immediate Integration</strong> (Risk Score &lt;3): Established exchanges with clear competitive advantages</li>
<li><strong>Cautious Integration</strong> (Risk Score 3-6): Emerging exchanges with good fundamentals but limited track record</li>
<li><strong>Monitoring Only</strong> (Risk Score &gt;6): High-risk exchanges requiring extensive due diligence</li>
</ol>
<p>To address the last point on my list, you will be able to see it on many exchanges that the quotes will change in their distribution as the average markup changes. This is because most market makers like Jump trading will have a retail quoter and a normal quoter. The retail quoter expects retail counterparties and is designed to maximize the market making metrics such as time on top of book, depth of book, etc, but it isn&rsquo;t used to getting picked off. If you pick them off too aggressively they&rsquo;ll switch to the normal quoter. You should keep this in mind when exploiting arbitrages. If you hit it too hard you&rsquo;ll scare off the retail quoter. The retail quoter can be easily picked off whereas the professional quoter is close to impossible to pick off and is what they&rsquo;ll quote on Binance etc. Not all exchanges will have this characteristic, I know Jump does this (they&rsquo;re often your counterparty), but if you trade against smaller names in the MM as a service industry their quotes will usually just be soft and they won&rsquo;t have an automated switching - in fact they may just shrink their quotes and leave it that way, sometimes they may just eat the loss.</p>
<p>Regarding exchange reward programs, often you get rewarded for the volume you generate either as a maker or a taker. Perhaps the edge for arbitrage is roughly equal to the cost of trading, but then when you add the reward program you realize you are actually up 1 bp on every dollar of volume. Reward programs make any edge you can come up with much easier to monetize since the threshold is much lower, on top of this, you&rsquo;ll often get an integration stipend of anywhere from 20-50k. I&rsquo;ve had ones in the 65-75k a month long, but those were for trading very specific products and didn&rsquo;t last very long. Typically anything above 20-30k is a great deal, and their availability will depend on the regime at the time. These usually are not advertised on the website so you&rsquo;ll need to be in talks with the exchange already for you to then tell you about it or be known as an MM in the industry. Regardless, it&rsquo;s basically free money to go and trade on the exchange, paid monthly usually for 3-6 months, but sometimes for longer than that.</p>
<p>Once you become one of the largest in terms of volume on that exchange, you can negotiate custom fees which will help your performance even more. This is a pretty common course of events I&rsquo;ve seen happen on most small exchanges I did arbitrage trading on.</p>
<p>On top of this, there&rsquo;s sometimes regimes where you can find easy money. If you monitor the funding rates, they sometime jump up to the 100%+ APR range on simple Bybit BTC spot vs perp funding arbitrages and sit there for a few weeks, maybe once a year this will happen. When it does, it&rsquo;s worth harvesting the easy money. This is mainly just a matter of having the capital available to do this when the opportunity arises. Speaking of regimes - there&rsquo;s also some fairly large spikes in the arbitrage opportunities during major market events like the ETH merge and FTX collapse that create exceptional opportunities for prepared traders.</p>
<p>The reality is that if you are trading big exchanges vs another big exchange then you are probably really damn good already (or not making a dime). The bulk of the money that you can actually make without a large team comes from trading small exchanges vs big exchanges, the stuff that is small enough to get ignored by the best of the best. Pick up niche edges, not huge general edges. It&rsquo;s much better to have a real chance at making 500K-1m than no chance whatsoever at 100m+&hellip; certainly at the start at least.</p>
<h2 id="execution">Execution</h2>
<p>Having the right execution to profit from arbitrage opportunities is essential to actually make money doing arbitrages. Sure, for some slower moving opportunities you can be much sloppier on the execution, but especially for strategies like spot, perp, and triangular arbitrage you need to think about execution. Even when there are high volatility events and lots of arbitrages show up (and last for a while at abnormally large levels) the execution does matter because the spreads will be very wide. You probably would make money still in that scenario, but basic limit quoting into the trade helps your bottom line a lot.</p>
<p><strong>Latency Optimization Stack:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Professional execution engine architecture</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">ExecutionEngine</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_connections</span><span class="p">()</span>  <span class="c1"># WebSocket connections</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span> <span class="o">=</span> <span class="n">OrderRouter</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">latency_monitor</span> <span class="o">=</span> <span class="n">LatencyMonitor</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="c1"># Pre-execution checks</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">check_limits</span><span class="p">(</span><span class="n">opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="c1"># Optimal execution path</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="n">execution_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">plan_execution</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="c1"># Execute with monitoring</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_plan</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">latency_monitor</span><span class="o">.</span><span class="n">record_execution</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></div><p><strong>Advanced Order Types for Professional Execution:</strong></p>
<ul>
<li><strong>Iceberg Orders</strong>: Hide large size while maintaining priority</li>
<li><strong>TWAP/VWAP Algorithms</strong>: For larger positions requiring market impact mitigation</li>
<li><strong>Hidden/Reserve Orders</strong>: Reduce information leakage</li>
<li><strong>Fill-or-Kill (FOK)</strong>: Critical for latency-sensitive triangular arbitrage</li>
<li><strong>Immediate-or-Cancel (IOC)</strong>: Standard for most arbitrage execution</li>
</ul>
<p><strong>Professional Latency Budgets:</strong></p>
<ul>
<li><strong>Market Data Reception</strong>: &lt;1ms (co-located), &lt;5ms (cloud)</li>
<li><strong>Signal Generation</strong>: &lt;0.5ms</li>
<li><strong>Order Generation</strong>: &lt;0.1ms</li>
<li><strong>Order Transmission</strong>: &lt;1ms (co-located), &lt;10ms (cloud)</li>
<li><strong>Exchange Processing</strong>: Variable (2-50ms depending on exchange)</li>
<li><strong>Total Latency Target</strong>: &lt;10ms for competitive opportunities</li>
</ul>
<p><strong>Infrastructure Considerations:</strong></p>
<ul>
<li><strong>Co-location</strong>: Essential for tier-1 exchanges (Binance, Bybit, OKX, etc.)</li>
<li><strong>Multiple Geographic Regions</strong>: Redundancy and latency optimization</li>
<li><strong>Dedicated Hardware</strong>: FPGA for ultra-low latency, high-end CPUs for complex strategies</li>
<li><strong>Network Optimization</strong>: Direct exchange connections, premium bandwidth providers**</li>
</ul>
<p>So what does great execution look like? Well, it&rsquo;s actually fairly similar to market making when you actually dig into it. You are executing into a position using limit orders. In fact, you can quote around Binance mid-price plus some spread and this will effectively end up capturing arbitrage differences as you&rsquo;ll look very tight when there is an arbitrage, but look very wide when the prices are aligned or the arbitrage is in the other direction. This doesn&rsquo;t even require maker orders as you can have orders in your own system that you don&rsquo;t show the market or even send to the exchange but do execute when the price crosses them (executing as a taker), this is similar to how a hitting machine works in market making.</p>
<p>Using limit orders to trade into your arbitrages is the default way of doing things, and taking should only occur when you believe the opportunity won&rsquo;t last for long enough to make into it, this is often not the case. In fact, the arbitrage opportunity is often created by the maker fill because without the maker fill there wouldn&rsquo;t be enough edge in the trade to turn a profit as a taker.</p>
<p>Execution isn&rsquo;t just about ensuring limit fills, it&rsquo;s also about being able to put lots of size into imbalances. Often when there is a dislocation, we don&rsquo;t want to just slam the price back into alignment, and especially for cases like funding arbitrages, we&rsquo;ll actually end up losing money if we do that since we rely on them paying part to earn funding. So a large part of execution is about trying to put size through an opportunity without moving the price, and as a corollary to that, figuring out the optimal amount of size to allocate before marginal utility actually starts to become negative for having more size in the trade (making the funding arbitrage converge for example).</p>
<h2 id="when-should-you-hedge">When should you hedge?</h2>
<p>Hedging costs money and that&rsquo;s something that you&rsquo;ll find is really scarce when running arbitrages. Every basis point of edge counts, you are really skimming very fine lines, and hedging is a whopping DOUBLE the cost! But aren&rsquo;t I giving up half the edge? This is a common misconception, when most people think about arbitrages they think about two assets meeting in the middle, but the reality is that one asset does all the moving and the other doesn&rsquo;t move at all. Especially if you are finding edges on smaller exchanges, the small exchange will do all the moving and Binance won&rsquo;t budge an inch. If you are doing spot or perp arbs (not funding!) you probably shouldn&rsquo;t ever hedge, not unless it&rsquo;s a large deviation and you have to lay down a lot of your book to fill the size (and are being compensated well enough to not have to mind your bps!). Funding arbitrage will be different to this hedging rule obviously — the noise of asset price moves will drown your funding PnL. If you aren&rsquo;t holding for very long you really shouldn&rsquo;t be doing any hedging, it&rsquo;ll cost too much. The intuition here is that if you are trading enough and holding for short enough that the risk of any individual trade made by your algorithm averages out over the long run then there really isn&rsquo;t much of a need to go about hedging. Funding arb is the exception because you are holding for very long and it definitely will not average out if you stop hedging, some people do still play around with the way funding arbitrages are hedged, but they&rsquo;re still hedging — just in a different way (we&rsquo;ll get into this in a bit when we dive into funding arbitrage specifically).</p>
<h2 id="when-you-have-to-predict">When You Have To Predict</h2>
<p>In almost every arbitrage, there&rsquo;s an element of prediction. Thinking that with arbitrage there will be no guesswork is a mistake. For an overview of things you may need to guess:</p>
<ol>
<li>How long a funding arbitrage lasts for?</li>
<li>Estimated liquidity when you actually trade?</li>
<li>Will a spot arbitrage still be there after I transfer my assets?</li>
<li>What is the estimated rate at which my arbitrages will fail?</li>
<li>When is the optimal time to enter into a perp arb?</li>
</ol>
<p><strong>Funding Rate Decay Models:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Professional funding rate decay prediction</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">FundingDecayPredictor</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_trained_model</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">            <span class="s1">&#39;current_funding_rate&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            <span class="s1">&#39;volume_ratio&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">            <span class="s1">&#39;open_interest_change&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">            <span class="s1">&#39;spot_perp_basis&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">            <span class="s1">&#39;market_volatility&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">            <span class="s1">&#39;time_of_day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">            <span class="s1">&#39;day_of_week&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">            <span class="s1">&#39;market_regime&#39;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="k">def</span> <span class="nf">predict_decay_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_rate</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="n">half_life</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>  <span class="c1"># Hours until 50% decay</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="n">decay_constant</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">half_life</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="k">return</span> <span class="n">decay_constant</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="k">def</span> <span class="nf">expected_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_rate</span><span class="p">,</span> <span class="n">position_size</span><span class="p">,</span> <span class="n">holding_period</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="n">decay_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_decay_rate</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">entry_rate</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="n">expected_rate</span> <span class="o">=</span> <span class="n">entry_rate</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">decay_rate</span> <span class="o">*</span> <span class="n">holding_period</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="k">return</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">expected_rate</span> <span class="o">*</span> <span class="n">holding_period</span> <span class="o">/</span> <span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Liquidity Prediction Models:</strong></p>
<ul>
<li><strong>Order Book Decay Functions</strong>: Model how liquidity disappears after large trades</li>
<li><strong>Market Impact Models</strong>: Predict price impact based on order size and market conditions</li>
<li><strong>Cross-Exchange Liquidity Correlation</strong>: Model how liquidity changes propagate between venues</li>
</ul>
<p><strong>Professional Risk Models:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Value-at-Risk for arbitrage positions</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">ArbitrageVaR</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_level</span> <span class="o">=</span> <span class="mf">0.99</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">lookback_period</span> <span class="o">=</span> <span class="mi">252</span>  <span class="c1"># Trading days</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">def</span> <span class="nf">calculate_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">correlation_matrix</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="c1"># Calculate portfolio variance</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="n">portfolio_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">positions</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">portfolio_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="c1"># VaR calculation</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">var</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_level</span><span class="p">)</span> <span class="o">*</span> <span class="n">portfolio_std</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">return</span> <span class="n">var</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="k">def</span> <span class="nf">scenario_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="p">{</span><span class="s1">&#39;market_crash&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;volatility_spike&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="p">{</span><span class="s1">&#39;exchange_outage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;affected_exchanges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;binance&#39;</span><span class="p">]}},</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="p">{</span><span class="s1">&#39;funding_shock&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;rate_change&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;affected_symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">]}}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">            <span class="n">pnl_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_scenario</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">scenario</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;scenario&#39;</span><span class="p">:</span> <span class="n">scenario</span><span class="p">,</span> <span class="s1">&#39;pnl_impact&#39;</span><span class="p">:</span> <span class="n">pnl_impact</span><span class="p">})</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></div><p><strong>Machine Learning Approaches:</strong></p>
<ul>
<li><strong>LSTM Networks</strong>: For time-series prediction of funding rates and spreads</li>
<li><strong>Random Forest</strong>: For classification of profitable vs unprofitable opportunities</li>
<li><strong>Reinforcement Learning</strong>: For optimal entry/exit timing</li>
<li><strong>Ensemble Methods</strong>: Combining multiple models for robust predictions**</li>
</ul>
<p>These are just a handful, but they can make a big difference on your PnL. In fact, for funding arbitrages the prediction actually matters more than the starting value. Say you have a coin with a 1300% APR funding rate. That may only be worth 800% after you deploy your size and move the price, and then after you take into account that it&rsquo;ll only last 1 day (according to your forecast model) you are left with only a handful of bps in returns, which can quickly become negative after you incorporate your transaction costs (which may also be high because it&rsquo;s probably very illiquid if the funding is this high). If you don&rsquo;t want to do this, trade big symbols on big exchanges only, otherwise get ready to do some forecasting, improving your model for estimating how long a funding arbitrage will last for example is one of the best ways to improve your edge. I&rsquo;ll talk a bit more about how this can be done in the funding arbitrage specific section.</p>
<h2 id="incompletes">Incompletes</h2>
<p>Incompletes are when one leg of your trade fills, but the other doesn&rsquo;t. This can end up being quite the expense if the rate of incompletes rises too much. Obviously, if you aren&rsquo;t hedging then there isn&rsquo;t a leg to be incomplete, but for spot arbitrages and triangular arbitrages you will almost always have to reconcile the other end. There&rsquo;s no partially doing a triangular arbitrage or you&rsquo;ll end up in some random currency you don&rsquo;t want.</p>
<div class="mermaid">sequenceDiagram
    participant Trader
    participant "Exchange A"
    participant "Exchange B"

    alt Successful Arbitrage
        Trader->>Exchange A: Send Buy Order (Leg 1)
        activate Exchange A
        Exchange A-->>Trader: Leg 1 Filled
        deactivate Exchange A

        Trader->>Exchange B: Send Sell Order (Leg 2)
        activate Exchange B
        Exchange B-->>Trader: Leg 2 Filled
        deactivate Exchange B

        Note over Trader: Profit Secured
    else Incomplete Trade
        Trader->>Exchange A: Send Buy Order (Leg 1)
        activate Exchange A
        Exchange A-->>Trader: Leg 1 Filled
        deactivate Exchange A

        Trader->>Exchange B: Send Sell Order (Leg 2)
        activate Exchange B
        Note over Exchange B: Price moves away
        Exchange B-->>Trader: Leg 2 Not Filled
        deactivate Exchange B

        Note over Trader: Unhedged Position Risk!
    end</div>
<p>As we discussed in the prediction section, you will need to predict when incompletes occurred. When I was trading arbitrages, I had to model on which exchanges and which types of trades and even which symbols incompletes occurred the most on. This reveals some staggeringly large concentrations in my incompletes that meant some traders were losers on average, and thus avoidable by not trading those types of setups.</p>
<p>Not just that, when we dug into how the incompletes were forming we realized that often stale data was causing us to miss legs, and after some system changes we resolved a large amount of incompletes in the system. These sorts of investigations that help you to optimize your PnL, and milk more from the arbitrages you are trading.</p>
<h2 id="normalization">Normalization</h2>
<p>Normalization is relevant specifically for funding arbitrages and perpetual arbitrages in order to accurately compare the two products. You can use an EWMA of the spread to normalize for sustained differences in the mean when doing perpetual arbitrage, and this is fairly effective (and good practice), but you will still have to deal with issues related to funding rates. Paraphrasing from my prior article on perpetual arbitrages which I think covers the topic of normalization quite nicely (so no point rewriting):</p>
<p>Using Binance&rsquo;s perpetual prices directly is not optimal, especially for platforms with shorter perpetual durations, like hourly ones on DEXs. This is because perpetual prices tend to converge towards the spot price in a pattern that resembles descending stairs until a funding payment occurs, which then causes a jump. We don&rsquo;t want to make trades that get us into a bad position on funding payments.</p>
<p>An alternative approach of relying solely on spot prices is also flawed. It may lead to imbalanced positions, favouring underperforming coins while shorting the surging ones. A potential solution is to &ldquo;clean&rdquo; the perpetual prices from a platform like Binance by accounting for accrued but unpaid funding payments, adjusting for rate differences, and then subtracting the accrued coupon for the specific platform you&rsquo;re converting to.</p>
<div class="mermaid">graph TD
    subgraph "Perpetual Price Normalization"
        A[Raw Perp Price] --> B("Adjust for Accrued Funding<br/>on Source Exchange")
        B --> C("Adjust for Funding<br/>Rate Differences")
        C --> D("Subtract Accrued Coupon<br/>for Target Exchange")
        D --> E[Normalized Price]
    end</div>
<p>This method is only moderately effective due to various challenges:</p>
<ol>
<li>Different indices used across platforms can lead to discrepancies, especially during volatile market conditions.</li>
<li>There are limits on how high funding payments can go, which vary by exchange.</li>
<li>Funding rates change frequently, affecting the conversion due to the non-linear nature of common funding formulas.</li>
<li>Practical implementation issues, such as determining accrued funding payments and adjusting for rate differences, considering the intricacies of funding rate formulas.</li>
</ol>
<p>The closest approach to a practical solution involves taking Binance&rsquo;s perpetual prices, adjusting for accrued funding payments and rate differences, and then recalculating the funding payments.</p>
<p>However, there&rsquo;s no one-size-fits-all formula for this, and you&rsquo;ll turn off specific exchange pairs or increase their entry thresholds in your system to try to counter this.</p>
<p>An ideal strategy involves analysing data to understand how funding payments evolve relative to premiums and devising cross-venue adjustments based on empirical evidence.</p>
<p>This should include models for predicting how spot prices will converge across different venues. These are mostly driven by relative volumes on each exchange.</p>
<p>We want to remember the notion of confidence throughout. If we deem two perp, to be very similar, we can give a higher confidence to it and then size up on a divergence to a greater extent. How that score is developed is up to you as the reader, but generally, it should include components like interval, index price formula, funding limits, and accrual formula.</p>
<p>In any of these trades, the funding rate can play a significant role in divergence if contracts are misaligned. Thus, we should take these into account for our final live version.</p>
<h2 id="reducing-trading-costs">Reducing Trading Costs</h2>
<p>Fees are a huge part of the costs you will have when you are trading and they can usually be reduced quite easily. Switching to making will give you quite a big improvement in fees from the start, even if you are on the worst tier, the improvement by switching to maker is fairly significant.</p>
<p>You used to be able to use a prime broker if you wanted better fees, but nowadays that doesn&rsquo;t work since fees are typically decided at a sub-account level, and not an account level by the top exchanges - this means prime brokers aren&rsquo;t very useful for this.</p>
<p>That said, if you need access to top fees, most SMA firms, especially those that focus on HFT will have top fee accounts. For some detail on what an SMA is, it&rsquo;s a separately managed account. It&rsquo;s similar to a hedge fund investor except instead of needing to set up a hedge fund legal structure, they just give you the key to the account and you trade their account with some contract in place which outlines compensation.</p>
<p>It&rsquo;s a fairly common, and lightweight structure, and by trading through their account you&rsquo;ll have access to the top fees. That said, you still need the connections to get SMA investors and the returns to back it up.</p>
<p>For smaller exchanges, they&rsquo;ll be willing to start you off on a trial for quite a bit of time at a top fee tier, and you can then use this to kickstart your volumes on said exchange. It shouldn&rsquo;t matter for smaller exchanges whether you have an SMA or not since it&rsquo;s fairly easy to become one of the top traders by volume. You&rsquo;ll only need an SMA if you are looking to trade on a top exchange - which as we discussed earlier isn&rsquo;t always ideal in terms of execution and hedging.</p>
<h3 id="trading-more-things">Trading more things</h3>
<p>This should be one of the more obvious ways to improve your PnL, but it is an important part of the decision making process, and that is - trading more things. Things: being exchanges, symbols, or types of instruments. Already got lots of symbols? Add another exchange! Already have lots of exchanges? Add coin margined perpetuals instead of just normal perpetuals!</p>
<p>This is probably one of the most common ways to ensure you are fully milking an opportunity. There is often a balancing act between trading better execution / general trading logic vs. integrating more exchanges. It really depends on the situation but either logic improvement, nor the opportunity to add the latest exchanges should be ignored in full favour of the other.</p>
<h3 id="leverage--borrowing">Leverage &amp; Borrowing</h3>
<p>When you hit the double digits in terms of Sharpe ratios, it starts to no longer matter about the risk side of things and you start to think about things in terms of the absolute dollar amount of return possible. One component of this is that it now becomes very easy to lever up the strategy because the risk component is fairly low. For many small traders, the capital component of the equation is sparse so leverage is a great way to acquire leverage you can get it directly through perpetuals which will typically let you get extremely levered, but this comes with it&rsquo;s own risks if you put this cross-exchange. A lot of people and their blowing their roofs up because the market moves 45% down and suddenly they&rsquo;re down 2 mill on one exchange and up 2 mill on another exchange. That hedged position becomes not so hedged anymore and you start getting liquidated on one side of the trade. Modelling your leverage across all sorts of shock scenarios where we assume various assets have big sudden moves that we won&rsquo;t have time to get out of the way of is extremely important or you will blow up your book. For more detail on how to calculate the shocks, take a look at the way Deribit calculates margin for options - that should be fairly instructive.</p>
<p><strong>Advanced Cross-Exchange Risk Management:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">CrossExchangeRiskManager</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Conservative for cross-exchange</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">margin_buffers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">            <span class="s1">&#39;binance&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>    <span class="c1"># 15% buffer above maintenance margin</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">            <span class="s1">&#39;okx&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>        <span class="c1"># 20% buffer for less liquid exchanges</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            <span class="s1">&#39;bybit&#39;</span><span class="p">:</span> <span class="mf">0.18</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_correlation_matrix</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">def</span> <span class="nf">calculate_portfolio_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Calculate portfolio Value-at-Risk across exchanges&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="c1"># Adjust for cross-exchange basis risk</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="n">adjusted_correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_for_basis_risk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="c1"># Calculate portfolio variance with correlation</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="n">portfolio_var</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pos_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                <span class="n">portfolio_var</span> <span class="o">+=</span> <span class="n">pos_i</span> <span class="o">*</span> <span class="n">pos_j</span> <span class="o">*</span> <span class="n">adjusted_correlation</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">portfolio_var</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.33</span>  <span class="c1"># 99% confidence</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">def</span> <span class="nf">stress_test_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Professional stress testing scenarios&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">            <span class="s1">&#39;crypto_winter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;btc&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.80</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;alts&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.95</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">            <span class="s1">&#39;exchange_hack&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exchange_down&#39;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span> <span class="s1">&#39;price_impact&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">            <span class="s1">&#39;funding_shock&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;funding_spike&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">},</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="s1">&#39;liquidity_crisis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;spread_widening&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;depth_reduction&#39;</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="k">for</span> <span class="n">scenario_name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">            <span class="n">pnl_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_scenario</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">scenario</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnl_impact</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></div><p><strong>Professional Borrowing Strategies:</strong></p>
<ul>
<li><strong>Prime Brokerage Leverage</strong>: 2-5x leverage at institutional rates (50-200 bps)</li>
<li><strong>DeFi Leverage</strong>: Compound, Aave integration for spot borrowing at competitive rates</li>
<li><strong>Exchange Native Margin</strong>: Cross-margin vs isolated margin optimization</li>
<li><strong>Repo Markets</strong>: Overnight and term funding for large positions</li>
</ul>
<h4 id="applying-the-kelly-criterion-for-optimal-sizing">Applying the Kelly Criterion for Optimal Sizing</h4>
<p>While leverage can amplify returns, it also amplifies risk. A systematic approach to position sizing is crucial to avoid the risk of ruin. This is where the Kelly Criterion comes in. Originally developed for gambling, it&rsquo;s a formula used to determine the optimal size for a series of bets to maximize the long-term growth rate of capital.</p>
<p>For investing and trading, a common form of the Kelly formula is:</p>
<p><code>Kelly % = E / V</code></p>
<p>Where:</p>
<ul>
<li><strong>E</strong> is the expected return of the strategy.</li>
<li><strong>V</strong> is the variance of the returns (which is the volatility squared).</li>
</ul>
<p>In the context of arbitrage, each opportunity can be seen as a positive expectancy &ldquo;bet&rdquo;. The Kelly Criterion helps answer the critical question: &ldquo;How much of my capital should I allocate to this specific arbitrage opportunity to maximize my growth without going broke?&rdquo;</p>
<h4 id="adapting-kelly-for-crypto-arbitrage">Adapting Kelly for Crypto Arbitrage</h4>
<p>The pure, unadjusted Kelly Criterion can be dangerously aggressive, especially in a market like crypto which is known for its &ldquo;fat-tailed&rdquo; distributions—meaning, extreme price swings happen far more often than a normal statistical distribution would predict. A full Kelly bet implicitly assumes you know the exact probabilities and payouts, which is never the case in real-world trading. A small error in estimating your edge or volatility could lead to catastrophic losses.</p>
<p>Because of this, professional traders almost always use a <strong>Fractional Kelly</strong>. This means betting a fraction (e.g., 50%, 25%, or even 10%) of the position size that the full Kelly formula suggests. This approach reduces portfolio volatility and lowers drawdowns, making the strategy more robust at the cost of a slightly lower (but safer) long-term growth rate.</p>
<p>This conservative adaptation is what you see in professional sizing algorithms. The goal is not just to maximize returns, but to ensure survival and consistency over the long run, which is paramount in trading.</p>
<p><strong>Dynamic Leverage Sizing:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">optimal_leverage</span><span class="p">(</span><span class="n">expected_return</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">sharpe_ratio</span><span class="p">,</span> <span class="n">max_drawdown_tolerance</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Kelly Criterion adapted for arbitrage strategies&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="c1"># Modified Kelly for non-normal returns</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="k">if</span> <span class="n">sharpe_ratio</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="c1"># High Sharpe strategies can use more aggressive sizing</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="n">kelly_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_return</span> <span class="o">/</span> <span class="n">volatility</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.75</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="c1"># Conservative Kelly for lower Sharpe</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">kelly_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_return</span> <span class="o">/</span> <span class="n">volatility</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1"># Cap leverage based on drawdown tolerance</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">max_leverage_dd</span> <span class="o">=</span> <span class="n">max_drawdown_tolerance</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">volatility</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">kelly_fraction</span><span class="p">,</span> <span class="n">max_leverage_dd</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># Cap at 10x</span>
</span></span></code></pre></div><p><strong>Professional Margin Management:</strong></p>
<ul>
<li><strong>Real-time Margin Monitoring</strong>: Cross-exchange margin utilization tracking</li>
<li><strong>Automated Deleveraging</strong>: Systematic position reduction during stress</li>
<li><strong>Cross-Exchange Netting</strong>: Optimize margin usage across venues</li>
<li><strong>Dynamic Hedging</strong>: Real-time delta and gamma hedging for large positions**</li>
</ul>
<p>To acquire spot leverage, you can borrow from the exchanges (which is typically quite expensive) or you can take out loans from external providers. Most prime brokers will offer you leverage as well as certain loan facility firms like Tesseraact which will write the debt against your book as a company (i.e. there is no liquidations here, you are taking on the debt directly as a company after showing them your books).</p>
<p>Borrowing isn&rsquo;t just about leverage though, it can also be about hedging. You often want to ensure you can hedge your buys on one exchange with a sell on another exchange, but for spot markets that means you need to get short on the other exchange. To get around this, you&rsquo;ll need to get spot borrow on the short exchange. Getting spot borrow is typically very expensive and only really worth it in huge dislocations where hedging becomes quite important (ie when the market breaks down), but even in those scenarios it struggles to make sense since there will be a scarce ability to acquire it. However, there is an exception, and that is funding arbitrages. In bear markets, the relationship tends to flip such that the future is usually below spot instead of above. This means that you will be longing the future and shorting spot. This requires the acquisition of spot borrow which can be acquired either on-chain or directly from the exchange. Funding arbitrage is the main strategy where spot borrow actually can play a critical role in whether it works out. With that said, funding arbitrage tends to be a lot less profitable in bear markets because spot borrow is much more expensive than shorting a future. When you short the future you get paid, and you pay nothing when you long spot, but when you short spot you have to pay and you get paid on the funding, so you end up with less profits in bear markets on funding arbitrages (which is one of the reasons why it is such a regime dependent strategy).</p>
<h3 id="funding-arbitrage">Funding Arbitrage</h3>
<p>Funding arbitrage can be done two ways. Either perp-perp or spot-perp.</p>
<p>Perp-perp is usually exclusively cross-exchange, and spot-perp can be either although it tends to be single exchange unless there is no spot market on the exchange. The reason for this is that spot prices will tend to be fairly equal across exchanges whereas perp funding rates will differ so you tend to just pick the easiest spot hedge (which tends to be on the same exchange as your perp for margin related reasons). Sometimes, you get exchanges which are exclusively perpetuals or they have terrible liquidity in their spot markets.</p>
<p>Bybit was like this when Bybit Spot had just opened and also before it was available. There was great trading in Bybit perpetuals but no liquidity (or before spot, no assets) for you to trade in the spot markets to cross-exchange was required. I bring this up because on Bybit, and other exchanges they often list the perpetual before the spot asset so you may still find that you need to do cross-exchange spot-perp arbitrages.</p>
<p>Typically, hedge funds will do exclusively single exchange trading because it&rsquo;s close to impossible to end up getting liquidated doing it whereas cross-exchange you can easily get liquidated if you don&rsquo;t manage your risk and because of this risk characteristics their investors will be very unhappy if they run anything cross-exchange. Generally, it&rsquo;s quite hard to raise for and tends to be run more by proprietary trading shops. Another reason proprietary trading firms tend to run cross-exchange over single exchange is because there is much more turnover on cross-exchange and thus they need to run less size and have better execution - both characteristics of most proprietary trading operations (smaller books, HFT desks they can pass flow into for execution).</p>
<p>On the <strong>Execution</strong> front, we will have 2 legs to our trade and thus can start with making into the first leg, and making out when we decide to exit. This is a very easy way to start improving the execution, if you do the full trade to take then your execution will be extremely sub-optimal. From here, most firms will then start making on the second leg as well, but perhaps with a bit more aggression than the first leg. There&rsquo;s quite a bit of time to put the position on so it&rsquo;s very well suited for making. The only reason we will want to be more aggressive on the second leg is because now we have an unhedged position on and our risk level should be reduced by putting on the second leg.</p>
<p>For the <strong>Prediction</strong> component of funding arbitrages, you will need to model how long the arbitrages will last and the rate at which they decay. Typically there will be some function you create which models the rate at which the opportunities decay towards some long-term mean. You can include variables such as the current volatility and the option market&rsquo;s expectation of volatility in this model as well as how much the overall market has gone up recently as part of this modelling, but generally you.</p>
<p>Another part of modelling you&rsquo;ll need to do for your decision making logic will be around the optimal amount of size to put through a trade. You need to find the amount that maximizes $ profit, subject to some minimum return constraint (perhaps measured relative to other opportunities). Maximizing profit at 5% APR isn&rsquo;t a very great move, but we also are willing to give up some of the APR in order to put significantly more size into it.</p>
<p>There are some modelling components to risk (not that it&rsquo;s prediction, but I&rsquo;ll include it next to it), but that&rsquo;s more a matter of simulating some large shocks and you should be fine beyond that. Just follow the way Deribit calculates margin for options in terms of how you shock your portfolio (minus the options volatility shocks of course!) and that will be a reasonable worst case loss model (although I would increase the market moves up/down for assets). Perhaps you would want to scale this with volatility of each coin as well. Just be intentionally conservative. Pushing your luck on risk will never end well.</p>
<p>In terms of <strong>trading more things</strong>, this is fairly simple. You just add more exchanges and make sure they are liquid and that you avoid any wash flow. Then from here make sure you are trading all the liquid coins on an exchange, and maybe even the illiquid coins but on smaller size. Some firms won&rsquo;t bother with the illiquid coins, and some firms will focus specifically on the illiquid coins. Illiquid coins tend to have much much higher APRs, but the capacity is practically ignore-able for the kinds of firms looking to put low 9 figures through funding arbitrage trades.</p>
<p>Leverage wise you can get most of the leverage you need from perpetuals, but if you need spot borrow for the bear market direction of funding arbitrages then scouring DeFi sources of on-chain borrow is one great way to find alpha.</p>
<p>If you want even more detail on how to do funding arbitrages as well as some examples, then check out this article which goes into additional detail:</p>
<h3 id="spot-arbitrage">Spot Arbitrage</h3>
<p>Spot arbitrage is the oldest form of arbitrage in cryptocurrency markets. It&rsquo;s also got quite a few more barriers than perpetual arbitrage because you often need to think about operational aspects like withdrawals and transfers. In fact, you often can&rsquo;t hedge on the other exchange either or trade one side of the arbitrage without holding inventory or getting borrow. For this reason, spot is probably one of the most complicated out of all of the arbitrage strategies. That said, it&rsquo;s probably the one with the best moat out of all of them — i.e. the longest time to decay in terms of what I&rsquo;ve seen.</p>
<p>For <strong>Execution</strong>, you typically don&rsquo;t have to be as aggressive as triangular arbitrage, but it is still far more aggressive than funding arbitrage. You will be doing the usual method discussed for execution such as making into the position, and ideally ending up trading purely on the smaller exchange but quoting in reference to the prices on the bigger exchange. This does not always work though, and sometimes we cannot rely on convergence to make our money.</p>
<p>In these cases we need to rely on moving cross-exchange transfers to reconcile the arbitrage between the exchanges directly. This requires us to build up a position on one exchange, and then when it is high enough we transfer it over to the larger exchange, and take the position off. We then transfer the resulting proceeds (either USDT or the coin depending on the direction of the arbitrage) back to our smaller exchange so that this capital can be used in more arbitrages.</p>
<p>This introduces a threshold problem for our modelling because there is a fixed cost to transfer between exchanges (most exchanges charge a flat fee and not a % of the value as a withdrawal fee). You also need to model how long the arbitrage will last or at least the rate it will decay at because if you build up a large position and then the arbitrage is gone before you get to transfer then you will lose all your PnL. On top of this, you need to model the expected rate of incompletes and the cost of these incompletes when determining whether you think an opportunity is profitable.</p>
<p>If you want even more detail on how to do spot arbitrages as well as some examples, then check out these 2 articles which goes into additional detail:</p>
<h1 id="perpetuals-arbitrage">Perpetuals Arbitrage</h1>
<p>Perpetuals Arbitrage is probably the easiest arbitrage strategy to get started without that you can generate serious returns with. Sure, funding arbitrage is easier, but it&rsquo;s very hard to make serious money on fairly minimal capital with. Funding arbitrage, of course, can be used to deploy lots of capital at a great rate of return, but it&rsquo;s close to impossible to hit the 2000% returns that some traders produce on their capital with higher turnover arbitrage opportunities like perpetual arbitrage.</p>
<p>The reason I say it is the easiest is because unlike spot and triangular arbitrage there are far less moving parts, and no aspects related to availability of spot borrow, inventory requirements, withdrawal cost (causing threshold optimal problems), and transfer times. It also lacks the operational challenges you have to deal with when doing geographic arbitrages.</p>
<h3 id="prediction">Prediction</h3>
<p>Prediction wise you need to determine the optimal point where you should trade into the spread and the expected rate of incompletes that you will hit. The rate of incompletes tends to vary between exchange combinations you are trading and even the time of the day, you should spend a lot of time analysing the incompletes so that you avoid missed / unprofitable trades. At minimum, you should have a baseline expectation of the cost from incompletes that is factored into your minimum trade profitability threshold.</p>
<h3 id="for-execution">For execution</h3>
<p>For execution, it&rsquo;s fairly similar to spot in that you need to use maker orders for at least one leg in the ideal case. You will notice that some opportunities are slower than others depending on the exchange. Often if an opportunity has already been around for a couple of seconds, the probability of it staying around for a another couple of seconds is quite high. I.e. the longer an opportunity has lasted, then the longer you can expect to have to trade into an opportunity and the lower your expected incomplete rate will be. Whereas, if an opportunity has just showed up on your scanner, there&rsquo;s a very high chance someone beats you to it if you aren&rsquo;t trading on a very uncompetitive exchange (which is of course another way to approach). If you can&rsquo;t keep up on the latency front then consider trading the slower opportunities. This rule also applies to spot when you are trying to determine the expected rate of decay — sometimes waiting is better than trading. There are other reasons to wait which relate to the deviation perhaps getting wider and you leaving money on the table by entering early — however you tune this usually by solving for the optimal setting for maximum profit in your (hopefully realistic) simulator. It&rsquo;s a simple grid search across parameters.</p>
<p>On the risk front, we&rsquo;ve already discussed the risk of blowing up across exchanges if you use too much leverage. Especially if a large jump has occurred, you may see exchanges depart from one another. You may want perpetuals to get back in line with one another.</p>
<p>If you want even more detail on how to do futures arbitrages as well as some examples, then check out these 2 articles which goes into additional detail:</p>
<h1 id="triangular-arbitrage">Triangular Arbitrage</h1>
<p>Triangular arbitrage is one of the more neglected types of strategies in my opinion. Even on Binance back in 2020/2021 I was able to capture significant profits trading triangular arbitrage, and even back then Binance was very efficient so this was fairly surprising. Especially when run in a cross-exchange and maker focused angle I think it would likely still work across various exchanges. Triangular arbitrage when run cross-exchange has the benefit of also capturing spot arbitrages quite optimally so there is a lot of overlap with spot arbitrage.</p>
<h3 id="in-terms-of-the-execution">In terms of the Execution</h3>
<p>In terms of the Execution for triangular arbitrage, typically you will make into the first leg of the trade. It&rsquo;s practically impossible to make money going full taker in triangular arbitrage because of the number of illiquid legs. In fact, ideally you do maker on the 2nd leg as this tends to be the most illiquid out of all the legs.</p>
<p>Typically, there is not much of a statistical or modelling element to triangular arbitrages. The only bit of modelling I used to have to do when I ran it was modelling how liquidity would disappear after a maker fill on the first leg. I could tell it wasn&rsquo;t an other trader beating me to it because there was no trades occurring, instead it was likely market makers widening their quotes in response to a large impact on the COIN/USDT symbol for the coin (since this was COIN/BTC or /ETH or /BNB or /BUSD they were were widening on). I would use the rule that roughly half of the liquidity would be gone by the time I go there, although this rule eventually shrunk as I got faster at it.</p>
<h3 id="on-the-risk-front">On the risk front</h3>
<p>On the risk front, you often need to hold inventory in the coin if you want to quote both sides of the book. This is one of the bigger challenges for triangular arbitrage. The buy side of the book is easy because you can quote bids from USDT, and similarly you can take against the ask from holding USDT, but if you want to take against the bid or quote asks then you need to be holding the coin itself. This then necessitates you hold inventory. Ideally, this is done selectively based on where the opportunities lie with an overall beta hedge in a more liquid asset&rsquo;s perpetuals, but it causes a lot of risk and takes up lots of capital to pull off so it is recommended to only start on the buy side of the trade. When I was trading triangular arbitrage, I found that whilst the sell side of the trade was slightly riskier, it didn&rsquo;t appear to be a huge difference. That said, this was not so true of the spot arbitrages where the sell side was often 2x as risky when I explored those so perhaps these observations are now outdated.</p>
<p><strong>Advanced Inventory Management:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">TriangularInventoryManager</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">target_inventory</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Target inventory levels by asset</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">risk_limits</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># Maximum inventory exposure per asset</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratios</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># Beta hedging ratios for each asset</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">def</span> <span class="nf">optimize_inventory_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Optimize inventory allocation across potential triangular arbs&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="c1"># Expected opportunity frequency by asset</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">opportunity_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_opportunity_frequency</span><span class="p">(</span><span class="n">opportunities</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="c1"># Risk-adjusted return per unit of inventory</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">risk_adj_return</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">opportunities</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">            <span class="n">expected_return</span> <span class="o">=</span> <span class="n">opportunity_freq</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_profit_per_trade</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="n">inventory_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_inventory_risk</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="n">risk_adj_return</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_return</span> <span class="o">/</span> <span class="n">inventory_risk</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="c1"># Allocate inventory proportional to risk-adjusted returns</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="n">total_capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_capital</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">risk_adj_return</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">return_ratio</span> <span class="ow">in</span> <span class="n">risk_adj_return</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">            <span class="n">weight</span> <span class="o">=</span> <span class="n">return_ratio</span> <span class="o">/</span> <span class="n">total_weight</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">            <span class="n">allocations</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_capital</span> <span class="o">*</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_factor</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="k">return</span> <span class="n">allocations</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="k">def</span> <span class="nf">dynamic_hedging_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inventory_positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Implement dynamic hedging for inventory risk&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="n">hedge_orders</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">inventory_positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_limits</span><span class="p">[</span><span class="n">asset</span><span class="p">]:</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">                <span class="c1"># Calculate optimal hedge size</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">                <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beta_to_btc</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">                <span class="n">hedge_size</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratios</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">                <span class="c1"># Create hedge order in BTC perpetual</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">                <span class="n">hedge_order</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">                    <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">hedge_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hedge_size</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;hedge&#39;</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">                <span class="n">hedge_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hedge_order</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="k">return</span> <span class="n">hedge_orders</span>
</span></span></code></pre></div><p><strong>Professional Execution Strategies:</strong></p>
<ul>
<li><strong>Multi-Leg Atomic Execution</strong>: Use exchange-specific order types for simultaneous execution</li>
<li><strong>Partial Fill Handling</strong>: Sophisticated incomplete trade management</li>
<li><strong>Liquidity Aggregation</strong>: Combine order book depth across multiple price levels</li>
<li><strong>Smart Order Routing</strong>: Dynamic routing based on real-time execution quality metrics</li>
</ul>
<p><strong>Risk Metrics for Professional Operations:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">calculate_triangular_risk_metrics</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">market_data</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="s2">&#34;&#34;&#34;Professional risk metrics for triangular arbitrage&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="c1"># Inventory-at-Risk (IaR)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="n">inventory_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">pos</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">market_data</span><span class="p">[</span><span class="n">asset</span><span class="p">][</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">                           <span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">inventory_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inventory_var</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.33</span>  <span class="c1"># 99% confidence</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="c1"># Path-dependent risk (risk of incomplete triangles)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">path_risk</span> <span class="o">=</span> <span class="n">calculate_path_dependency_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1"># Liquidity risk (risk of market impact)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="n">liquidity_risk</span> <span class="o">=</span> <span class="n">calculate_liquidity_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">market_data</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="c1"># Total risk</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="n">total_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inventory_at_risk</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">path_risk</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">liquidity_risk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="s1">&#39;inventory_at_risk&#39;</span><span class="p">:</span> <span class="n">inventory_at_risk</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="s1">&#39;path_risk&#39;</span><span class="p">:</span> <span class="n">path_risk</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="s1">&#39;liquidity_risk&#39;</span><span class="p">:</span> <span class="n">liquidity_risk</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="s1">&#39;total_risk&#39;</span><span class="p">:</span> <span class="n">total_risk</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="s1">&#39;risk_adjusted_return&#39;</span><span class="p">:</span> <span class="n">expected_return</span> <span class="o">/</span> <span class="n">total_risk</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p><strong>Professional Opportunity Detection:</strong></p>
<ul>
<li><strong>Graph-Based Arbitrage Detection</strong>: Use graph algorithms to find optimal N-leg arbitrages</li>
<li><strong>Real-Time Cycle Detection</strong>: Identify profitable cycles as they emerge</li>
<li><strong>Cross-Exchange Triangle Optimization</strong>: Optimize triangles across multiple exchanges simultaneously</li>
<li><strong>Dynamic Path Selection</strong>: Choose optimal execution paths based on current market conditions**</li>
</ul>
<h3 id="on-the-latency-front">On the latency front</h3>
<p>On the latency front we can optimize the latency of most taker triangular arbitrages by detecting when the price is near the threshold for when we would want to trade, and then spam limit IOCs at the price where there would be an arbitrage, especially if we think that the price will approach this quite soon. It will soak up our rate limit so you ideally would want to get special rate limit increases on the exchange / ensure that this is an especially good opportunity, but it&rsquo;s a latency trick which is practically unbeatable in terms of speed. You&rsquo;ll have the fill before anyone even has the data packet.</p>
<p>If you want even more detail on how to do triangular arbitrages as well as some examples, then check out this article which goes into additional detail:</p>
<h2 id="professional-implementation-guide-triangular-arbitrage-systems">Professional Implementation Guide: Triangular Arbitrage Systems</h2>
<h3 id="mathematical-foundation-and-graph-theory">Mathematical Foundation and Graph Theory</h3>
<p>Triangular arbitrage opportunities can be mathematically represented as negative-weight cycles in a currency graph. For professional implementation, we model this as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">class</span> <span class="nc">TriangularArbitrageDetector</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">price_matrix</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">min_profit_threshold</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 0.1% minimum profit</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">def</span> <span class="nf">update_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol_prices</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Update the price graph with latest market data&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">symbol_prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="c1"># Add edges for both directions</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                                  <span class="n">price</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">                                  <span class="n">price</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;sell&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">def</span> <span class="nf">find_arbitrage_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Use Bellman-Ford algorithm to detect negative cycles&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">            <span class="c1"># Bellman-Ford will raise exception if negative cycle exists</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">            <span class="n">nx</span><span class="o">.</span><span class="n">bellman_ford_path_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="s1">&#39;USDT&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">NetworkXUnbounded</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="c1"># Negative cycle detected, extract profitable paths</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_profitable_cycles</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="k">def</span> <span class="nf">extract_profitable_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Extract and validate profitable arbitrage cycles&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="n">cycles</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Minimum triangular</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">                <span class="n">profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cycle_profit</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">                <span class="k">if</span> <span class="n">profit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_profit_threshold</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">                    <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">                        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">cycle</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">                        <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">                        <span class="s1">&#39;execution_plan&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_execution_plan</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">                    <span class="p">})</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="advanced-execution-architecture">Advanced Execution Architecture</h3>
<p>Professional triangular arbitrage requires sophisticated execution management to handle the multi-leg nature and timing constraints:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">ProfessionalTriangularExecutor</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_clients</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="n">exchange_clients</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">TriangularRiskManager</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">execution_monitor</span> <span class="o">=</span> <span class="n">ExecutionMonitor</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_manager</span> <span class="o">=</span> <span class="n">TriangularInventoryManager</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_triangular_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Execute triangular arbitrage with professional risk management&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="c1"># Pre-execution validation</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">validate_opportunity</span><span class="p">(</span><span class="n">opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;risk_limits&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="c1"># Inventory check and allocation</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="n">required_inventory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_required_inventory</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_manager</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span><span class="n">required_inventory</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_inventory&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="c1"># Execute with sophisticated order management</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="n">execution_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_multi_leg</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="c1"># Post-execution analysis and inventory rebalancing</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_execution_analysis</span><span class="p">(</span><span class="n">execution_results</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="k">return</span> <span class="n">execution_results</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_multi_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Execute multi-leg arbitrage with optimal timing&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="n">legs</span> <span class="o">=</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;execution_plan&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="c1"># Execute first leg (usually the most liquid)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="n">first_leg</span> <span class="o">=</span> <span class="n">legs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="n">first_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_leg</span><span class="p">(</span><span class="n">first_leg</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;immediate&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_result</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="k">if</span> <span class="n">first_result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;first_leg_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="c1"># Execute remaining legs with adjusted sizes based on first leg fill</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">actual_size</span> <span class="o">=</span> <span class="n">first_result</span><span class="p">[</span><span class="s1">&#39;filled_size&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">            <span class="n">adjusted_leg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_leg_size</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">            <span class="n">leg_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_leg</span><span class="p">(</span><span class="n">adjusted_leg</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;urgent&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leg_result</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">
</span></span><span class="line"><span class="ln">49</span><span class="cl">            <span class="c1"># If any leg fails, implement damage control</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">            <span class="k">if</span> <span class="n">leg_result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">damage_control</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">legs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">
</span></span><span class="line"><span class="ln">54</span><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</span></span></code></pre></div><h3 id="real-time-market-microstructure-analysis">Real-Time Market Microstructure Analysis</h3>
<p>Professional triangular arbitrage systems must understand and adapt to market microstructure:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">MarketMicrostructureAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">order_book_analyzer</span> <span class="o">=</span> <span class="n">OrderBookAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_predictor</span> <span class="o">=</span> <span class="n">LiquidityPredictor</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span> <span class="o">=</span> <span class="n">MarketImpactModel</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">def</span> <span class="nf">analyze_execution_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol_pair</span><span class="p">,</span> <span class="n">intended_size</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Analyze expected execution quality for triangular arbitrage leg&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">order_book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book_analyzer</span><span class="o">.</span><span class="n">get_current_book</span><span class="p">(</span><span class="n">symbol_pair</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="c1"># Calculate effective spread and market impact</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">effective_spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_effective_spread</span><span class="p">(</span><span class="n">order_book</span><span class="p">,</span> <span class="n">intended_size</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="n">market_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span><span class="o">.</span><span class="n">predict_impact</span><span class="p">(</span><span class="n">symbol_pair</span><span class="p">,</span> <span class="n">intended_size</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="c1"># Analyze liquidity depth and resilience</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="n">liquidity_metrics</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="s1">&#39;depth_at_bps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_depth_at_bps</span><span class="p">(</span><span class="n">order_book</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">]),</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="s1">&#39;order_book_imbalance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_imbalance</span><span class="p">(</span><span class="n">order_book</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="s1">&#39;recent_volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_volatility</span><span class="p">(</span><span class="n">symbol_pair</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">            <span class="s1">&#39;average_trade_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_average_trade_size</span><span class="p">(</span><span class="n">symbol_pair</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="c1"># Predict post-trade liquidity recovery</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="n">recovery_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_predictor</span><span class="o">.</span><span class="n">predict_recovery_time</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">            <span class="n">symbol_pair</span><span class="p">,</span> <span class="n">intended_size</span><span class="p">,</span> <span class="n">liquidity_metrics</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="s1">&#39;effective_spread&#39;</span><span class="p">:</span> <span class="n">effective_spread</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="s1">&#39;market_impact&#39;</span><span class="p">:</span> <span class="n">market_impact</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">            <span class="s1">&#39;liquidity_metrics&#39;</span><span class="p">:</span> <span class="n">liquidity_metrics</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">            <span class="s1">&#39;recovery_time&#39;</span><span class="p">:</span> <span class="n">recovery_time</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">            <span class="s1">&#39;execution_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_execution_score</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">                <span class="n">effective_spread</span><span class="p">,</span> <span class="n">market_impact</span><span class="p">,</span> <span class="n">liquidity_metrics</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="k">def</span> <span class="nf">calculate_optimal_leg_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangle_opportunity</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Determine optimal execution sequence based on microstructure&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="n">legs</span> <span class="o">=</span> <span class="n">triangle_opportunity</span><span class="p">[</span><span class="s1">&#39;legs&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="c1"># Analyze each leg&#39;s execution characteristics</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="n">leg_analysis</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">            <span class="n">leg_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_execution_quality</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">                <span class="n">leg</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span> <span class="n">leg</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">        <span class="c1"># Optimize sequence based on:</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="c1"># 1. Liquidity (start with most liquid)</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">        <span class="c1"># 2. Market impact (minimize cumulative impact)</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">        <span class="c1"># 3. Timing sensitivity (fastest recovery first)</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">
</span></span><span class="line"><span class="ln">55</span><span class="cl">        <span class="n">sequence_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">legs</span><span class="p">))):</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_execution_sequence</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">leg_analysis</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">            <span class="n">sequence_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">perm</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">
</span></span><span class="line"><span class="ln">60</span><span class="cl">        <span class="n">optimal_sequence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sequence_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">legs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">optimal_sequence</span><span class="p">]</span>
</span></span></code></pre></div><h3 id="advanced-risk-management-and-position-sizing">Advanced Risk Management and Position Sizing</h3>
<p>Professional triangular arbitrage requires sophisticated risk management beyond basic inventory limits:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">AdvancedTriangularRiskManager</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">var_calculator</span> <span class="o">=</span> <span class="n">TriangularVaRCalculator</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">correlation_model</span> <span class="o">=</span> <span class="n">AssetCorrelationModel</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stress_tester</span> <span class="o">=</span> <span class="n">TriangularStressTester</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">def</span> <span class="nf">calculate_optimal_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">,</span> <span class="n">current_portfolio</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Calculate optimal position size using advanced risk metrics&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="c1"># Base Kelly sizing adjusted for triangular arbitrage specifics</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="n">expected_return</span> <span class="o">=</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="n">estimated_volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_triangular_volatility</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="c1"># Account for path-dependent risk (incomplete triangles)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="n">incomplete_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_incomplete_risk</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="n">adjusted_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">estimated_volatility</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">incomplete_risk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="c1"># Kelly fraction with conservative adjustment</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="n">kelly_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_return</span> <span class="o">/</span> <span class="n">adjusted_volatility</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="c1"># Portfolio-level risk constraints</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="n">portfolio_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_calculator</span><span class="o">.</span><span class="n">calculate_portfolio_var</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">            <span class="n">current_portfolio</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">,</span> <span class="n">kelly_fraction</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="n">max_size_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_size_for_var_limit</span><span class="p">(</span><span class="n">portfolio_var</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="c1"># Liquidity constraints</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">max_size_liquidity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_size_liquidity</span><span class="p">(</span><span class="n">opportunity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="c1"># Final position size</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="n">optimal_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">kelly_fraction</span><span class="p">,</span> <span class="n">max_size_var</span><span class="p">,</span> <span class="n">max_size_liquidity</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">optimal_size</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="s1">&#39;kelly_fraction&#39;</span><span class="p">:</span> <span class="n">kelly_fraction</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">            <span class="s1">&#39;var_constraint&#39;</span><span class="p">:</span> <span class="n">max_size_var</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">            <span class="s1">&#39;liquidity_constraint&#39;</span><span class="p">:</span> <span class="n">max_size_liquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">            <span class="s1">&#39;risk_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">                <span class="s1">&#39;expected_return&#39;</span><span class="p">:</span> <span class="n">expected_return</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">                <span class="s1">&#39;estimated_volatility&#39;</span><span class="p">:</span> <span class="n">adjusted_volatility</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">                <span class="s1">&#39;incomplete_risk&#39;</span><span class="p">:</span> <span class="n">incomplete_risk</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">                <span class="s1">&#39;portfolio_var&#39;</span><span class="p">:</span> <span class="n">portfolio_var</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="k">def</span> <span class="nf">real_time_risk_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_triangular_positions</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Monitor triangular arbitrage positions in real-time&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">        <span class="n">risk_alerts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">
</span></span><span class="line"><span class="ln">52</span><span class="cl">        <span class="k">for</span> <span class="n">position_id</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">active_triangular_positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">            <span class="c1"># Check for partial fills creating unhedged exposure</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_unhedged_exposure</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">                <span class="n">risk_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;unhedged_exposure&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">                    <span class="s1">&#39;position_id&#39;</span><span class="p">:</span> <span class="n">position_id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;complete_triangle_or_hedge&#39;</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl">            <span class="c1"># Monitor inventory concentration</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">            <span class="n">inventory_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_inventory_concentration_risk</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">            <span class="k">if</span> <span class="n">inventory_risk</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_inventory_risk</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">                <span class="n">risk_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;inventory_concentration&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">                    <span class="s1">&#39;position_id&#39;</span><span class="p">:</span> <span class="n">position_id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce_inventory_exposure&#39;</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">
</span></span><span class="line"><span class="ln">72</span><span class="cl">            <span class="c1"># Check for adverse price movements</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">            <span class="n">current_pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_current_pnl</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">            <span class="k">if</span> <span class="n">current_pnl</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl">                <span class="n">risk_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;stop_loss_breach&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl">                    <span class="s1">&#39;position_id&#39;</span><span class="p">:</span> <span class="n">position_id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl">                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;critical&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">79</span><span class="cl">                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;immediate_exit&#39;</span>
</span></span><span class="line"><span class="ln">80</span><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="ln">81</span><span class="cl">
</span></span><span class="line"><span class="ln">82</span><span class="cl">        <span class="k">return</span> <span class="n">risk_alerts</span>
</span></span></code></pre></div><h3 id="performance-analytics-and-optimization">Performance Analytics and Optimization</h3>
<p>Professional systems require comprehensive performance analysis to continuously improve:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">class</span> <span class="nc">TriangularPerformanceAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">execution_analyzer</span> <span class="o">=</span> <span class="n">ExecutionAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attribution_analyzer</span> <span class="o">=</span> <span class="n">AttributionAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine</span> <span class="o">=</span> <span class="n">OptimizationEngine</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">def</span> <span class="nf">comprehensive_performance_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">historical_trades</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Comprehensive analysis of triangular arbitrage performance&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="c1"># Basic performance metrics</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="n">basic_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_basic_metrics</span><span class="p">(</span><span class="n">historical_trades</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="c1"># Risk-adjusted metrics</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="n">risk_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_adjusted_metrics</span><span class="p">(</span><span class="n">historical_trades</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="c1"># Execution quality analysis</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="n">execution_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_execution_quality</span><span class="p">(</span><span class="n">historical_trades</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="c1"># Attribution analysis</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="n">attribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribution_analyzer</span><span class="o">.</span><span class="n">analyze_returns</span><span class="p">(</span><span class="n">historical_trades</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="c1"># Regime analysis</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="n">regime_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_regime_performance</span><span class="p">(</span><span class="n">historical_trades</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">            <span class="s1">&#39;basic_metrics&#39;</span><span class="p">:</span> <span class="n">basic_metrics</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">            <span class="s1">&#39;risk_metrics&#39;</span><span class="p">:</span> <span class="n">risk_metrics</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">            <span class="s1">&#39;execution_metrics&#39;</span><span class="p">:</span> <span class="n">execution_metrics</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">            <span class="s1">&#39;attribution&#39;</span><span class="p">:</span> <span class="n">attribution</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="s1">&#39;regime_performance&#39;</span><span class="p">:</span> <span class="n">regime_performance</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="s1">&#39;optimization_recommendations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_optimization_recommendations</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">                <span class="n">basic_metrics</span><span class="p">,</span> <span class="n">risk_metrics</span><span class="p">,</span> <span class="n">execution_metrics</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="k">def</span> <span class="nf">generate_optimization_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basic_metrics</span><span class="p">,</span> <span class="n">risk_metrics</span><span class="p">,</span> <span class="n">execution_metrics</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="s2">&#34;&#34;&#34;Generate actionable optimization recommendations&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="c1"># Execution optimization</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="k">if</span> <span class="n">execution_metrics</span><span class="p">[</span><span class="s1">&#39;average_slippage&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0005</span><span class="p">:</span>  <span class="c1"># 5 bps</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;execution&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">                <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;high_slippage&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Implement more sophisticated order routing and timing&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">                <span class="s1">&#39;expected_improvement&#39;</span><span class="p">:</span> <span class="s1">&#39;2-4 bps per trade&#39;</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">        <span class="c1"># Risk optimization</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="k">if</span> <span class="n">risk_metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;risk&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">                <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;low_sharpe&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Improve opportunity selection criteria and position sizing&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">                <span class="s1">&#39;expected_improvement&#39;</span><span class="p">:</span> <span class="s1">&#39;15-25% Sharpe improvement&#39;</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">
</span></span><span class="line"><span class="ln">59</span><span class="cl">        <span class="c1"># Capacity optimization</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">        <span class="k">if</span> <span class="n">basic_metrics</span><span class="p">[</span><span class="s1">&#39;average_trade_size&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_optimal_trade_size</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;capacity&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">                <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;underutilized_capacity&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Increase position sizes within risk limits&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">                <span class="s1">&#39;expected_improvement&#39;</span><span class="p">:</span> <span class="s1">&#39;20-40</span><span class="si">% r</span><span class="s1">eturn improvement&#39;</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">
</span></span><span class="line"><span class="ln">68</span><span class="cl">        <span class="k">return</span> <span class="n">recommendations</span>
</span></span></code></pre></div><p>This professional implementation framework provides the foundation for institutional-quality triangular arbitrage systems, incorporating advanced mathematical modeling, sophisticated risk management, and comprehensive performance analytics that professional traders require for consistent profitability in competitive markets.</p>
<h1 id="geographic-arbitrage">Geographic Arbitrage</h1>
<p>Geographic arbitrage is mostly an operational trade in all honesty, and whilst you can improve some of the trade by making into certain legs and trading certain statistical effects, the ways you optimize geographic arbitrages are fairly specific to geographic arbitrage. For that reason, I will re-direct you the actual specific article on it since it doesn&rsquo;t fall in line with a lot of the general points discussed in this article. The optimizations still help, but for geographic arbitrage most of the edge is being able to even pull it off in the first place. This is the main priority so a lot of the optimizations are a bit less necessary for this trade specifically.</p>
</div>
  </div>
</div>
</div>
    </div><div id="footer" class="mb-5">
    <hr>
    
    <div class="container text-center">
        
            <a href="https://twitter.com/" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:chiayongkang@hotmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
            <a href="https://github.com/yongkangc" class="fab fa-github fa-1x" title="Github"></a>
        
    </div>
    
    
        <div class="container text-center">
            <a href="https://chiayong.com/chiayong.com" title="Yong Kang" ><small>Yong Kang</small></a>
        </div>
    
</div>


    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"
      integrity="sha512-igl8WEUuas9kG1o1XQysYI22rdap5LeOKlBpSYs4iOXchRtr2xj3XDTFF/0VE32LI/upcNnpRno2iN3VazgH4w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script><script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

<style>
  .mermaid-container {
    position: relative;
    margin: 2rem 0;
    background-color: var(--code-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    overflow: visible;
     
    box-sizing: border-box;
    contain: layout;
  }

  .mermaid-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
    display: flex;
    gap: 4px;
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .mermaid-container:hover .mermaid-controls {
    opacity: 1;
  }

  .mermaid-btn {
    background: var(--background);
    border: 1px solid var(--border-color);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  .mermaid-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .mermaid-fullscreen-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    padding: 2rem;
    box-sizing: border-box;
  }

  .mermaid-fullscreen-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--code-bg);
    border-radius: 8px;
    overflow: hidden;
  }

  .mermaid-fullscreen-controls {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 1000;
    display: flex;
    gap: 8px;
  }

  .mermaid-fullscreen-btn {
    background: var(--background);
    border: 1px solid var(--border-color);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  .mermaid-fullscreen-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .mermaid-close-btn {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
  }

  .mermaid-close-btn:hover {
    background: #c82333;
    border-color: #c82333;
  }

   
  .mermaid {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
  }

  .mermaid svg {
    max-width: 100%;
    height: auto;
    background: transparent !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif !important;
     
    transform-origin: center center !important;
     
    shape-rendering: geometricPrecision !important;
    text-rendering: geometricPrecision !important;
  }

   
  .mermaid svg text,
  .mermaid svg tspan,
  .mermaid svg foreignObject,
  .mermaid svg foreignObject div,
  .mermaid svg .nodeLabel,
  .mermaid svg .edgeLabel,
  .mermaid svg .cluster-label,
  .mermaid svg .titleText {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif !important;
    font-size: 14px !important;
    font-weight: normal !important;
    line-height: 1.2 !important;
    color: #e5e5e5 !important;
    fill: #e5e5e5 !important;
    text-anchor: middle !important;
     
    vector-effect: non-scaling-stroke !important;
  }

   
  .mermaid svg .titleText {
    font-size: 16px !important;
    font-weight: 600 !important;
  }

  .mermaid svg .cluster-label {
    font-size: 12px !important;
    font-weight: 500 !important;
  }

   
  .mermaid svg path,
  .mermaid svg line,
  .mermaid svg polyline {
    stroke: #888888 !important;
    stroke-width: 2px !important;
     
    vector-effect: non-scaling-stroke !important;
  }

   
  .mermaid svg marker path {
    fill: #888888 !important;
    vector-effect: non-scaling-stroke !important;
  }

  .mermaid svg .edgeLabel {
    background-color: var(--code-bg) !important;
    color: var(--text) !important;
  }

   
  .mermaid svg * {
    box-sizing: content-box !important;
  }

   
  .mermaid svg .node rect,
  .mermaid svg .node circle,
  .mermaid svg .node ellipse,
  .mermaid svg .node polygon {
    fill: #2a2a2a !important;
    stroke: #555555 !important;
    stroke-width: 2px !important;
    vector-effect: non-scaling-stroke !important;
  }

  .mermaid-fullscreen-content svg {
    cursor: grab;
    user-select: none;
  }

  .mermaid-fullscreen-content svg:active {
    cursor: grabbing;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    
    mermaid.initialize({
      startOnLoad: true,
      theme: "dark",
    });

    
    function initializeMermaidControls() {
      document
        .querySelectorAll(".mermaid")
        .forEach(function (mermaidDiv, index) {
          const svg = mermaidDiv.querySelector("svg");
          if (!svg) return;

          
          if (svg.hasAttribute("data-mermaid-initialized")) return;
          svg.setAttribute("data-mermaid-initialized", "true");

          
          const container = document.createElement("div");
          container.className = "mermaid-container";
          mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
          container.appendChild(mermaidDiv);

          
          const diagramId = "mermaid-diagram-" + index;
          svg.id = diagramId;

          
          const controls = document.createElement("div");
          controls.className = "mermaid-controls";
          controls.innerHTML = `
          <button class="mermaid-btn" onclick="zoomMermaidIn('${diagramId}')">+</button>
          <button class="mermaid-btn" onclick="zoomMermaidOut('${diagramId}')">−</button>
          <button class="mermaid-btn" onclick="resetMermaidZoom('${diagramId}')">Reset</button>
          <button class="mermaid-btn" onclick="openMermaidFullscreen('${diagramId}')">⛶</button>
        `;
          container.appendChild(controls);

          
          let originalViewBox;
          try {
            originalViewBox = svg.viewBox.baseVal;
          } catch (e) {
            console.warn("Could not access viewBox:", e);
            return;
          }

          
          if (!originalViewBox || originalViewBox.width === 0) {
            try {
              const bbox = svg.getBBox();
              if (bbox.width > 0 && bbox.height > 0) {
                svg.setAttribute(
                  "viewBox",
                  `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`
                );
                const newViewBox = svg.viewBox.baseVal;
                svg.zoomState = {
                  scale: 1,
                  translateX: 0,
                  translateY: 0,
                  originalViewBox: {
                    x: newViewBox.x,
                    y: newViewBox.y,
                    width: newViewBox.width,
                    height: newViewBox.height,
                  },
                };
              } else {
                console.warn("Invalid bounding box for SVG");
                return;
              }
            } catch (e) {
              console.warn("Could not get bounding box:", e);
              return;
            }
          } else {
            svg.zoomState = {
              scale: 1,
              translateX: 0,
              translateY: 0,
              originalViewBox: {
                x: originalViewBox.x,
                y: originalViewBox.y,
                width: originalViewBox.width,
                height: originalViewBox.height,
              },
            };
          }

          
          function updateTransform(targetSvg = svg) {
            const state = targetSvg.zoomState || {
              scale: 1,
              translateX: 0,
              translateY: 0,
              originalViewBox: {
                x: originalViewBox.x,
                y: originalViewBox.y,
                width: originalViewBox.width,
                height: originalViewBox.height,
              },
            };

            
            const newWidth = state.originalViewBox.width / state.scale;
            const newHeight = state.originalViewBox.height / state.scale;

            
            const translateFactorX = -state.translateX / state.scale;
            const translateFactorY = -state.translateY / state.scale;

            
            const newX = state.originalViewBox.x + translateFactorX;
            const newY = state.originalViewBox.y + translateFactorY;

            targetSvg.setAttribute(
              "viewBox",
              `${newX} ${newY} ${newWidth} ${newHeight}`
            );
          }

          
          window.zoomMermaidIn = function (svgId) {
            const targetSvg = document.getElementById(svgId);
            if (targetSvg && targetSvg.zoomState) {
              targetSvg.zoomState.scale = Math.min(
                targetSvg.zoomState.scale * 1.2,
                5
              );
              updateTransform(targetSvg);
            }
          };

          window.zoomMermaidOut = function (svgId) {
            const targetSvg = document.getElementById(svgId);
            if (targetSvg && targetSvg.zoomState) {
              targetSvg.zoomState.scale = Math.max(
                targetSvg.zoomState.scale / 1.2,
                0.1
              );
              updateTransform(targetSvg);
            }
          };

          window.resetMermaidZoom = function (svgId) {
            const targetSvg = document.getElementById(svgId);
            if (targetSvg && targetSvg.zoomState) {
              targetSvg.zoomState.scale = 1;
              targetSvg.zoomState.translateX = 0;
              targetSvg.zoomState.translateY = 0;
              updateTransform(targetSvg);
            }
          };

          
          window.openMermaidFullscreen = function (svgId) {
            const originalSvg = document.getElementById(svgId);
            if (!originalSvg) return;

            
            const modal = document.createElement("div");
            modal.className = "mermaid-fullscreen-modal";
            modal.innerHTML = `
            <div class="mermaid-fullscreen-content">
              <div class="mermaid-fullscreen-controls">
                <button class="mermaid-fullscreen-btn" onclick="zoomMermaidIn('${svgId}-fullscreen')">+</button>
                <button class="mermaid-fullscreen-btn" onclick="zoomMermaidOut('${svgId}-fullscreen')">−</button>
                <button class="mermaid-fullscreen-btn" onclick="resetMermaidZoom('${svgId}-fullscreen')">Reset</button>
                <button class="mermaid-fullscreen-btn mermaid-close-btn" onclick="closeMermaidFullscreen()">✕</button>
              </div>
            </div>
          `;

            
            const clonedSvg = originalSvg.cloneNode(true);
            clonedSvg.id = svgId + "-fullscreen";
            
            const originalViewBox = originalSvg.viewBox.baseVal;
            clonedSvg.zoomState = {
              scale: 1,
              translateX: 0,
              translateY: 0,
              originalViewBox: {
                x: originalViewBox.x,
                y: originalViewBox.y,
                width: originalViewBox.width,
                height: originalViewBox.height,
              },
            };

            
            modal
              .querySelector(".mermaid-fullscreen-content")
              .appendChild(clonedSvg);
            document.body.appendChild(modal);

            
            modal.style.display = "block";

            
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let startTranslateX = 0;
            let startTranslateY = 0;

            clonedSvg.addEventListener("mousedown", function (e) {
              isDragging = true;
              dragStartX = e.clientX;
              dragStartY = e.clientY;
              startTranslateX = clonedSvg.zoomState.translateX;
              startTranslateY = clonedSvg.zoomState.translateY;
            });

            document.addEventListener("mousemove", function (e) {
              if (isDragging && clonedSvg.zoomState) {
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;

                clonedSvg.zoomState.translateX = startTranslateX + deltaX;
                clonedSvg.zoomState.translateY = startTranslateY + deltaY;
                updateTransform(clonedSvg);
              }
            });

            document.addEventListener("mouseup", function () {
              isDragging = false;
            });

            
            clonedSvg.addEventListener("wheel", function (e) {
              e.preventDefault();
              const delta = e.deltaY > 0 ? 0.9 : 1.1;
              clonedSvg.zoomState.scale = Math.max(
                0.1,
                Math.min(5, clonedSvg.zoomState.scale * delta)
              );
              updateTransform(clonedSvg);
            });

            
            const escapeHandler = function (e) {
              if (e.key === "Escape") {
                closeMermaidFullscreen();
                document.removeEventListener("keydown", escapeHandler);
              }
            };
            document.addEventListener("keydown", escapeHandler);

            
            modal.addEventListener("click", function (e) {
              if (e.target === modal) {
                closeMermaidFullscreen();
              }
            });
          };

          window.closeMermaidFullscreen = function () {
            const modal = document.querySelector(".mermaid-fullscreen-modal");
            if (modal) {
              modal.remove();
            }
          };

          
          svg.addEventListener("wheel", function (e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            svg.zoomState.scale = Math.max(
              0.1,
              Math.min(5, svg.zoomState.scale * delta)
            );
            updateTransform();
          });
        });
    }

    
    let attempts = 0;
    const maxAttempts = 10;

    function tryInitialize() {
      initializeMermaidControls();
      attempts++;

      
      const uninitializedDiagrams = document.querySelectorAll(
        ".mermaid svg:not([data-mermaid-initialized])"
      );

      if (uninitializedDiagrams.length > 0 && attempts < maxAttempts) {
        setTimeout(tryInitialize, 200);
      }
    }

    
    if (typeof mermaid !== "undefined") {
      
      const mermaidElements = document.querySelectorAll(".mermaid");
      if (mermaidElements.length > 0) {
        mermaid
          .run({
            nodes: mermaidElements,
          })
          .then(() => {
            
            setTimeout(initializeMermaidControls, 100);
          })
          .catch((error) => {
            console.error("Mermaid rendering failed:", error);
            
            setTimeout(tryInitialize, 500);
          });
      }
    } else {
      
      setTimeout(tryInitialize, 500);
    }
  });
</script>

  </body>
</html>
